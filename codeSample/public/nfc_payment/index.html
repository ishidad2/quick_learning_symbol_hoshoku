<!DOCTYPE html>
<html>
<head>
  <title>WebUSB RC-S380 Example</title>
  <meta charset="utf-8">
</head>
<body>
  <h1>WebUSB RC-S380 Example</h1>
  <button id="connect">Connect to NFC Reader</button>
  <pre id="output"></pre>
  <script>
    const connectButton = document.getElementById('connect');
    const outputElem = document.getElementById('output');

    function log(message) {
      outputElem.textContent += message + '\n';
    }

    async function connectToNFCReader() {
      try {
        const device = await navigator.usb.requestDevice({
          filters: [
            { vendorId: 0x054C, productId: 0x06C3 } // RC-S380 VendorID and ProductID
          ]
        });

        await device.open();
        log('Device opened.');

        await device.selectConfiguration(1);
        await device.claimInterface(0);

        const data = new Uint8Array([0xD4, 0x4A, 0x01, 0x00]); // RC-S380 Get UID command

        await device.controlTransferOut({
          requestType: 'vendor',
          recipient: 'device',
          request: 0x00,
          value: 0x0000,
          index: 0x0000
        }, data);

        const response = await device.controlTransferIn({
          requestType: 'vendor',
          recipient: 'device',
          request: 0x00,
          value: 0x0000,
          index: 0x0000
        }, 64);

        if (response.status === 'ok') {
          const uid = new Uint8Array(response.data.buffer.slice(4, response.data.byteLength - 1));
          log('NFC tag UID: ' + Array.from(uid).map(b => b.toString(16).padStart(2, '0')).join(' '));
        } else {
          log('Failed to read NFC tag.');
        }

        await device.close();
        log('Device closed.');

      } catch (error) {
        log(`Error: ${error}`);
      }
    }

    connectButton.addEventListener('click', connectToNFCReader);
  </script>
</body>
</html>
